# base_track_predictor.py

This module defines `BaseTrackerPredictor`, an iterative framework for predicting object tracks across frames. It combines correlation sampling, MLP encoding, positional embeddings, and transformer‚Äêbased updates to refine track coordinates and features over multiple iterations.

## Classes

### `BaseTrackerPredictor`
**Description:**  
High-level tracker that:
1. Samples initial features at given query points.
2. Constructs correlation volumes between track features and multi-scale feature maps.
3. Encodes correlations via an MLP.
4. Embeds flow offsets and coordinates.
5. Feeds concatenated features into a transformer (EfficientUpdateFormer).
6. Updates track coordinates and features iteratively.
7. Predicts visibility and optional confidence scores.

**Constructor Args:**
- `stride` (`int`): Downsample factor of input feature maps relative to original image.
- `corr_levels` (`int`): Number of pyramid levels in `CorrBlock`.
- `corr_radius` (`int`): Sampling radius per level in `CorrBlock`.
- `latent_dim` (`int`): Dimension of the internal track feature embeddings.
- `hidden_size` (`int`): Hidden size inside transformer blocks.
- `use_spaceatt` (`bool`): Whether to enable spatial attention in the transformer.
- `depth` (`int`): Number of transformer layers for time (and space if enabled).
- `max_scale` (`int`): Maximum coordinate scale for flow embedding normalization.
- `predict_conf` (`bool`): Whether to output per-track confidence scores.

**Attributes:**
- `corr_mlp`: MLP mapping raw sampled correlations to `latent_dim`.
- `query_ref_token`: Learnable tokens prepended to transformer inputs.
- `updateformer`: Instance of `EfficientUpdateFormer`.
- `ffeat_updater`: Linear+GELU for refining track features.
- `vis_predictor`: Linear head for visibility.
- `conf_predictor` (optional): Linear head for confidence.

**Forward Args:**
- `query_points` (`Tensor[B, N, 2]`): Initial (x,y) track estimates in the first frame.
- `fmaps` (`Tensor[B, S, C, H, W]`): Feature maps for each of `S` frames.
- `iters` (`int`): Number of refinement iterations (default: 6).
- `return_feat` (`bool`): If `True`, also returns intermediate features.
- `down_ratio` (`int`): Additional downsampling factor applied to `query_points`.
- `apply_sigmoid` (`bool`): Whether to apply sigmoid to visibility and confidence logits.

**Returns:**
If `return_feat` is `False`:
- `coord_preds` (`List[Tensor]`): List of coordinate predictions per iteration, each of shape `(B, S, N, 2)`.
- `vis_e` (`Tensor[B, S, N]`): Visibility scores.
- `conf_e` (`Tensor[B, S, N]` or `None`): Confidence scores (if `predict_conf`).

If `return_feat` is `True`, additionally returns:
- `track_feats`: Refined track features.
- `query_track_feat`: Initial track features from the first frame.

**Usage Example:**
```python
from heads.track_modules.base_track_predictor import BaseTrackerPredictor

# Initialize predictor
predictor = BaseTrackerPredictor(stride=4, corr_levels=4, corr_radius=4,
                                 latent_dim=128, hidden_size=384,
                                 use_spaceatt=True, depth=6,
                                 max_scale=512, predict_conf=True)

# Forward pass:
# query_pts: Tensor[B, N, 2], fmaps: Tensor[B, S, C, H, W]
coord_preds, vis, conf = predictor(query_pts, fmaps, iters=6)
```

*Generated by developer documentation script.*