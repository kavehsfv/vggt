# utils.py

This module provides utility functions for positional embeddings and feature sampling, used by the tracking head for coordinate embedding and correlation extraction.

## Functions

### `get_2d_sincos_pos_embed(embed_dim, grid_size, return_grid=False)`
**Description:**  
Wrapper that creates a 2D sin-cos positional embedding for a grid of size `(grid_size_h, grid_size_w)` with total dimension `embed_dim`, returning a tensor of shape `(1, embed_dim, grid_h, grid_w)`.

**Args:**
- `embed_dim` (`int`): Total embedding dimension (must be even).
- `grid_size` (`int` or `Tuple[int,int]`): Height and width of the grid.
- `return_grid` (`bool`): If `True`, also returns the underlying coordinate grid.

**Returns:**
- `pos_embed` (`Tensor[1, embed_dim, H, W]`): 2D positional embeddings.
- `(optional) grid` (`Tensor[2, H, W]`): Meshgrid of coordinates.

### `get_2d_sincos_pos_embed_from_grid(embed_dim, grid)`
**Description:**  
Generates a 2D sin-cos embedding from a provided coordinate `grid` of shape `(2, 1, H, W)` (with y,x coordinates).

**Args:**
- `embed_dim` (`int`): Embedding dimension (even).
- `grid` (`Tensor[2, 1, H, W]`): Stacked coordinate maps.

**Returns:**
Tensor of shape `(H*W, embed_dim)` listing the positional embedding per flatten index.

### `get_1d_sincos_pos_embed_from_grid(embed_dim, pos)`
**Description:**  
Computes a 1D sin-cos embedding for a vector of positions `pos`.

**Args:**
- `embed_dim` (`int`): Embedding dimension (even).
- `pos` (`Tensor[M]`): 1D array of positions.

**Returns:**
Tensor of shape `(1, M, embed_dim)` containing sin and cos embeddings.

### `get_2d_embedding(xy, C, cat_coords=True)`
**Description:**  
Embeds 2D coordinates `xy` using sin-cos positional functions. Optionally concatenates raw coordinates.

**Args:**
- `xy` (`Tensor[B, N, 2]`): x,y coordinates.
- `C` (`int`): Base embedding size for sin-cos (total output if `cat_coords=False` is `2*C`).
- `cat_coords` (`bool`): If `True`, concatenates original `xy` to the embedding (output dim `2+2*C`).

**Returns:**
Tensor of shape `(B, N, 2*C + (2 if cat_coords else 0))`.

### `bilinear_sampler(input, coords, align_corners=True, padding_mode="border")`
**Description:**  
Samples `input` at arbitrary `coords` using bilinear interpolation, wrapping `torch.nn.functional.grid_sample` with a coordinate convention where `coords` are in pixel units.

**Args:**
- `input` (`Tensor[B, C, ...]`): Feature map of shape `(B, C, H, W)` or `(B, C, T, H, W)`.
- `coords` (`Tensor[B, ..., 2 or 3]`): Sampling coordinates in pixel units.
- `align_corners` (`bool`): Passed to `grid_sample`.
- `padding_mode` (`str`): `"zeros"`, `"border"`, or `"reflection"`.

**Returns:**
Sampled tensor of same rank as `input` with values interpolated at `coords`.

### `sample_features4d(input, coords)`
**Description:**  
Convenience wrapper for sampling a 4D feature map `(B, C, H, W)` at a set of `coords` `(B, R, 2)`, returning features of shape `(B, R, C)`.

**Args:**
- `input` (`Tensor[B, C, H, W]`): Spatial feature map.
- `coords` (`Tensor[B, R, 2]`): Pixel coordinates to sample.

**Returns:**
Tensor of shape `(B, R, C)` containing interpolated features.

*Generated by developer documentation script.*