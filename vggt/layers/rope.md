# rope.py

This module implements 2D Rotary Position Embeddings (RoPE), enabling spatial position encoding for transformer models on image patches.

## Classes

### `PositionGetter`

**Description:**  
Generates and caches 2D grid coordinates for patch tokens. Given `(height, width)`, it returns a tensor of shape `(batch_size, height*width, 2)` containing (y, x) coordinates.

**Usage:**  
```python
from vggt.layers.rope import PositionGetter
getter = PositionGetter()
positions = getter(batch_size, H', W', device)
```

### `RotaryPositionEmbedding2D`

**Description:**  
Applies rotary position embeddings separately along vertical and horizontal dimensions. Splits feature vectors into two halves, rotates each half using precomputed sine/cosine bases based on 2D positions, and concatenates the results.

**Constructor Args:**
- `frequency` (`float`): Base frequency for computing rotary embeddings.
- `scaling_factor` (`float`): Scaling factor applied to frequencies.

**Key Methods:**
- `_compute_frequency_components(dim, seq_len, device, dtype)`: Computes and caches cosine and sine components.
- `_rotate_features(x)`: Internal helper for rotating feature dimensions.
- `_apply_1d_rope(tokens, positions, cos_comp, sin_comp)`: Applies 1D RoPE along one axis.
- `forward(tokens, positions)`: Main entry applying 2D RoPE to `tokens` of shape `(B, n_heads, n_tokens, dim)`.

**Usage Example:**
```python
from vggt.layers.rope import PositionGetter, RotaryPositionEmbedding2D
getter = PositionGetter()
rope = RotaryPositionEmbedding2D(frequency=100.0)
positions = getter(batch_size, H', W', device)
rotated = rope(tokens, positions)
```

*Generated by developer documentation script.*

## Contents

### Class `PositionGetter`

Generates and caches 2D spatial positions for patches in a grid.

This class efficiently manages the generation of spatial coordinates for patches
in a 2D grid, caching results to avoid redundant computations.

Attributes:
    position_cache: Dictionary storing precomputed position tensors for different
        grid dimensions.

### Class `RotaryPositionEmbedding2D`

2D Rotary Position Embedding implementation.

This module applies rotary position embeddings to input tokens based on their
2D spatial positions. It handles the position-dependent rotation of features
separately for vertical and horizontal dimensions.

Args:
    frequency: Base frequency for the position embeddings. Default: 100.0
    scaling_factor: Scaling factor for frequency computation. Default: 1.0

Attributes:
    base_frequency: Base frequency for computing position embeddings.
    scaling_factor: Factor to scale the computed frequencies.
    frequency_cache: Cache for storing precomputed frequency components.